<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVerve</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Global variables
        let userId = null;
        let userBalance = 0;
        let cvFilesArray = [];
        let jdFilesArray = [];
        let pdfFilesArray = [];
        let isUserIdVisible = true;
        let isDarkMode = false;

        // Function to toggle dark mode
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            const body = document.body;
            const darkModeIcon = document.getElementById('darkModeIcon');
            
            if (isDarkMode) {
                body.classList.add('dark');
                darkModeIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                `;
                localStorage.setItem('darkMode', 'true');
            } else {
                body.classList.remove('dark');
                darkModeIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                `;
                localStorage.setItem('darkMode', 'false');
            }
        }

        // Function to initialize dark mode from localStorage
        function initializeDarkMode() {
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode === 'true') {
                isDarkMode = true;
                document.body.classList.add('dark');
                document.getElementById('darkModeIcon').innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                `;
            }
        }

        // Function to truncate filename in the middle
        function truncateFilename(filename, maxLength = 25) {
            if (filename.length <= maxLength) return filename;
            
            const extension = filename.split('.').pop();
            const nameWithoutExt = filename.slice(0, -(extension.length + 1));
            const charsToShow = maxLength - extension.length - 3; // 3 for "..."
            
            if (charsToShow < 5) return filename.slice(0, maxLength - 3) + '...';
            
            const start = nameWithoutExt.slice(0, Math.floor(charsToShow / 2));
            const end = nameWithoutExt.slice(-Math.ceil(charsToShow / 2));
            return `${start}...${end}.${extension}`;
        }

        // Function to generate a unique user ID
        function generateUserId() {
            return 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now().toString(36);
        }

        // Function to copy text to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showMessage('success', 'User ID copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        // Function to toggle User ID visibility
        function toggleUserIdVisibility() {
            isUserIdVisible = !isUserIdVisible;
            const userIdElement = document.getElementById('dashboardUserId');
            const eyeIcon = document.getElementById('eyeIcon');
            
            if (isUserIdVisible) {
                userIdElement.textContent = userId;
                eyeIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                `;
            } else {
                userIdElement.textContent = '••••••••••••••••••';
                eyeIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                `;
            }
        }

        // Function to show/hide login screen
        function toggleLoginScreen(show) {
            document.getElementById('loginScreen').classList.toggle('hidden', !show);
            document.getElementById('mainApp').classList.toggle('hidden', show);
            if (!show) {
                // After showing the main app, attach event listeners
                attachEventListeners();
            }
        }

        // Function to attach event listeners to buttons
        function attachEventListeners() {
            // Attach event listener for Merge PDFs button
            const mergePdfBtn = document.getElementById('mergePdfBtn');
            if (mergePdfBtn) {
                mergePdfBtn.addEventListener('click', mergePdfs);
            }

            // Attach event listener for Download Merged PDF button
            const downloadPdfBtn = document.getElementById('downloadPdfBtn');
            if (downloadPdfBtn) {
                downloadPdfBtn.addEventListener('click', downloadMergedPdf);
            }

            // Attach event listener for Generate Application Letter button
            const generateLetterBtn = document.getElementById('generateLetterBtn');
            if (generateLetterBtn) {
                generateLetterBtn.addEventListener('click', generateLetter);
            }

            // Attach event listener for Download Letter button
            const downloadLetterBtn = document.getElementById('downloadLetterBtn');
            if (downloadLetterBtn) {
                downloadLetterBtn.addEventListener('click', downloadLetterAsPdf);
            }

            // Attach event listener for Confirm Payment button
            const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
            if (confirmPaymentBtn) {
                confirmPaymentBtn.addEventListener('click', confirmPayment);
            }

            // Attach event listeners for file inputs
            const cvFileInput = document.getElementById('cvFile');
            if (cvFileInput) {
                cvFileInput.addEventListener('change', handleCvFileSelect);
            }

            const jdFileInput = document.getElementById('jdFile');
            if (jdFileInput) {
                jdFileInput.addEventListener('change', handleJdFileSelect);
            }

            const pdfFileInput = document.getElementById('pdfInput');
            if (pdfFileInput) {
                pdfFileInput.addEventListener('change', handlePdfFileSelect);
            }
        }

        // Function to handle CV file selection
        function handleCvFileSelect(event) {
            const files = Array.from(event.target.files);
            cvFilesArray = [...cvFilesArray, ...files];
            updateCvFilesList();
            // Clear the input so same file can be selected again if needed
            event.target.value = '';
        }

        // Function to handle JD file selection
        function handleJdFileSelect(event) {
            const files = Array.from(event.target.files);
            jdFilesArray = [...jdFilesArray, ...files];
            updateJdFilesList();
            // Clear the input so same file can be selected again if needed
            event.target.value = '';
        }

        // Function to handle PDF file selection
        function handlePdfFileSelect(event) {
            const files = Array.from(event.target.files);
            pdfFilesArray = [...pdfFilesArray, ...files];
            updatePdfFilesList();
            // Clear the input so same file can be selected again if needed
            event.target.value = '';
        }

        // Function to update CV files list display
        function updateCvFilesList() {
            const container = document.getElementById('cvFilesList');
            const counter = document.getElementById('cvFilesCounter');
            container.innerHTML = '';
            
            // Update counter - position it next to the button
            counter.textContent = `${cvFilesArray.length} file${cvFilesArray.length !== 1 ? 's' : ''} selected`;
            counter.className = `text-sm font-medium ${cvFilesArray.length > 0 ? 'text-indigo-600' : 'text-gray-500'}`;
            
            if (cvFilesArray.length === 0) {
                return;
            }
            
            cvFilesArray.forEach((file, index) => {
                const fileElement = document.createElement('div');
                fileElement.className = 'flex items-center justify-between bg-white p-2 rounded border border-gray-200 mb-2 dark:bg-gray-700 dark:border-gray-600';
                fileElement.innerHTML = `
                    <div class="flex items-center space-x-2 min-w-0 flex-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 flex-shrink-0 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <span class="text-sm text-gray-700 truncate dark:text-gray-300" title="${file.name}">${truncateFilename(file.name)}</span>
                        <span class="text-xs text-gray-500 flex-shrink-0 dark:text-gray-400">(${(file.size / 1024).toFixed(1)} KB)</span>
                    </div>
                    <button onclick="removeCvFile(${index})" class="text-red-500 hover:text-red-700 p-1 rounded-full flex-shrink-0 ml-2 dark:text-red-400 dark:hover:text-red-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
                container.appendChild(fileElement);
            });
        }

        // Function to update JD files list display
        function updateJdFilesList() {
            const container = document.getElementById('jdFilesList');
            const counter = document.getElementById('jdFilesCounter');
            container.innerHTML = '';
            
            // Update counter - position it next to the button
            counter.textContent = `${jdFilesArray.length} file${jdFilesArray.length !== 1 ? 's' : ''} selected`;
            counter.className = `text-sm font-medium ${jdFilesArray.length > 0 ? 'text-indigo-600' : 'text-gray-500'}`;
            
            if (jdFilesArray.length === 0) {
                return;
            }
            
            jdFilesArray.forEach((file, index) => {
                const fileElement = document.createElement('div');
                fileElement.className = 'flex items-center justify-between bg-white p-2 rounded border border-gray-200 mb-2 dark:bg-gray-700 dark:border-gray-600';
                fileElement.innerHTML = `
                    <div class="flex items-center space-x-2 min-w-0 flex-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 flex-shrink-0 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <span class="text-sm text-gray-700 truncate dark:text-gray-300" title="${file.name}">${truncateFilename(file.name)}</span>
                        <span class="text-xs text-gray-500 flex-shrink-0 dark:text-gray-400">(${(file.size / 1024).toFixed(1)} KB)</span>
                    </div>
                    <button onclick="removeJdFile(${index})" class="text-red-500 hover:text-red-700 p-1 rounded-full flex-shrink-0 ml-2 dark:text-red-400 dark:hover:text-red-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
                container.appendChild(fileElement);
            });
        }

        // Function to update PDF files list display
        function updatePdfFilesList() {
            const container = document.getElementById('pdfFilesList');
            const counter = document.getElementById('pdfFilesCounter');
            container.innerHTML = '';
            
            // Update counter - position it next to the button
            counter.textContent = `${pdfFilesArray.length} file${pdfFilesArray.length !== 1 ? 's' : ''} selected`;
            counter.className = `text-sm font-medium ${pdfFilesArray.length > 0 ? 'text-indigo-600' : 'text-gray-500'}`;
            
            if (pdfFilesArray.length === 0) {
                return;
            }
            
            pdfFilesArray.forEach((file, index) => {
                const fileElement = document.createElement('div');
                fileElement.className = 'flex items-center justify-between bg-white p-2 rounded border border-gray-200 mb-2 dark:bg-gray-700 dark:border-gray-600';
                fileElement.innerHTML = `
                    <div class="flex items-center space-x-2 min-w-0 flex-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 flex-shrink-0 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <span class="text-sm text-gray-700 truncate dark:text-gray-300" title="${file.name}">${truncateFilename(file.name)}</span>
                        <span class="text-xs text-gray-500 flex-shrink-0 dark:text-gray-400">(${(file.size / 1024).toFixed(1)} KB)</span>
                    </div>
                    <button onclick="removePdfFile(${index})" class="text-red-500 hover:text-red-700 p-1 rounded-full flex-shrink-0 ml-2 dark:text-red-400 dark:hover:text-red-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
                container.appendChild(fileElement);
            });
        }

        // Function to remove CV file
        function removeCvFile(index) {
            cvFilesArray.splice(index, 1);
            updateCvFilesList();
        }

        // Function to remove JD file
        function removeJdFile(index) {
            jdFilesArray.splice(index, 1);
            updateJdFilesList();
        }

        // Function to remove PDF file
        function removePdfFile(index) {
            pdfFilesArray.splice(index, 1);
            updatePdfFilesList();
        }

        // Show loading overlay
        function showLoadingOverlay(message) {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        // Hide loading overlay
        function hideLoadingOverlay() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // Update loading progress for letter generation
        function updateLetterProgress(step) {
            const steps = [
                "Preparing your files...",
                "Organizing your letter...", 
                "Generating letter..."
            ];
            
            document.getElementById('loadingMessage').textContent = steps[step - 1];
            document.getElementById('progressBar').style.width = `${(step / 3) * 100}%`;
        }

        // Function to handle user login
        async function handleLogin() {
            const inputUserId = document.getElementById('userIdInput').value.trim();
            
            if (!inputUserId) {
                showMessage('error', 'Please enter your User ID');
                return;
            }

            showLoadingOverlay('Logging in...');

            try {
                // Check if user exists in database
                const response = await fetch('/.netlify/functions/get-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ userId: inputUserId }),
                });

                const data = await response.json();

                if (response.ok) {
                    userId = inputUserId;
                    userBalance = data.balance;
                    
                    // Update UI
                    document.getElementById('dashboardUserId').textContent = userId;
                    document.getElementById('balanceDisplay').textContent = userBalance.toFixed(2);
                    
                    toggleLoginScreen(false);
                    showMessage('success', 'Login successful!');
                } else {
                    showMessage('error', data.error || 'User not found');
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage('error', 'Login failed. Please try again.');
            } finally {
                hideLoadingOverlay();
            }
        }

        // Function to generate new user ID
        async function generateNewUserId() {
            const newUserId = generateUserId();
            
            // Show generated ID to user
            document.getElementById('generatedUserId').textContent = newUserId;
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('newUserIdSection').classList.remove('hidden');
            
            // Animate the copy button
            const copyBtn = document.getElementById('copyUserIdBtn');
            copyBtn.classList.add('animate-pulse');
            
            // Store the generated ID for later use
            window.generatedUserId = newUserId;
        }

        // Function to copy generated user ID
        function copyGeneratedUserId() {
            copyToClipboard(window.generatedUserId);
            
            // Stop the animation after copying
            document.getElementById('copyUserIdBtn').classList.remove('animate-pulse');
        }

        // Function to show save confirmation
        function showSaveConfirmation() {
            document.getElementById('saveConfirmation').classList.remove('hidden');
        }

        // Function to handle save confirmation response
        async function handleSaveConfirmation(saved) {
            document.getElementById('saveConfirmation').classList.add('hidden');
            
            if (saved) {
                showLoadingOverlay('Creating your account...');
                
                try {
                    // Create new user in database
                    const response = await fetch('/.netlify/functions/create-user', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            userId: window.generatedUserId,
                            balance: 0 
                        }),
                    });

                    if (response.ok) {
                        userId = window.generatedUserId;
                        userBalance = 0;
                        
                        // Update UI
                        document.getElementById('dashboardUserId').textContent = userId;
                        document.getElementById('balanceDisplay').textContent = '0.00';
                        
                        toggleLoginScreen(false);
                        showMessage('success', 'Account created successfully!');
                    } else {
                        const data = await response.json();
                        showMessage('error', data.error || 'Failed to create account');
                    }
                } catch (error) {
                    console.error('Account creation error:', error);
                    showMessage('error', 'Account creation failed. Please try again.');
                } finally {
                    hideLoadingOverlay();
                }
            } else {
                // If user didn't save, show the ID again
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('newUserIdSection').classList.add('hidden');
                showMessage('warning', 'Please save your User ID to continue');
            }
        }

        // Show message function
        function showMessage(type, message) {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            messageBox.className = `fixed inset-x-0 bottom-4 mx-auto p-4 rounded-lg shadow-lg z-50 max-w-sm ${type === 'success' ? 'bg-emerald-500' : type === 'error' ? 'bg-red-500' : 'bg-yellow-500'} text-white text-center font-bold transition-all duration-300 transform scale-0`;
            messageText.textContent = message;
            setTimeout(() => {
                messageBox.classList.add('scale-100');
            }, 10);
            setTimeout(() => {
                messageBox.classList.remove('scale-100');
            }, 3000);
        }

        // Show popup function for image-based PDFs
        function showImageBasedPdfPopup(fileType) {
            const popup = document.getElementById('imageBasedPdfPopup');
            const messageElement = document.getElementById('imageBasedPdfMessage');
            
            if (fileType === 'cv') {
                messageElement.textContent = 'Your CV PDF is image-based and cannot be extracted. Please upload screenshots of your CV instead.';
            } else if (fileType === 'jd') {
                messageElement.textContent = 'Your Job Description PDF is image-based and cannot be extracted. Please upload screenshots of the Job Description instead.';
            }
            
            popup.classList.remove('hidden');
        }

        // Close popup function
        function closeImageBasedPdfPopup() {
            const popup = document.getElementById('imageBasedPdfPopup');
            popup.classList.add('hidden');
        }

        // Initialize the app
        window.onload = function() {
            toggleLoginScreen(true);
            initializeDarkMode();
        };

        // --- Tab Switching Logic ---
        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('border-b-2', 'border-indigo-500');
            });
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
            document.getElementById(`${tabName}-button`).classList.add('border-b-2', 'border-indigo-500');
        };

        // --- PDF Merger Logic ---
        let mergedPdf = null;

        async function mergePdfs() {
            if (pdfFilesArray.length < 2) {
                showMessage('error', 'Please select at least two PDF files to merge.');
                return;
            }

            const cost = 0.95;

            if (userBalance < cost) {
                showMessage('error', `Not enough balance. Please top up your account. Cost: ${cost} ETB`);
                return;
            }

            showLoadingOverlay('Merging PDFs...');

            try {
                const { PDFDocument } = window.PDFLib;
                const mergedDoc = await PDFDocument.create();

                for (const file of pdfFilesArray) {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdfDoc = await PDFDocument.load(arrayBuffer);
                    const copiedPages = await mergedDoc.copyPages(pdfDoc, pdfDoc.getPageIndices());
                    copiedPages.forEach(page => mergedDoc.addPage(page));
                }

                mergedPdf = await mergedDoc.save();
                document.getElementById('downloadPdfBtn').classList.remove('hidden');
                showMessage('success', 'PDFs merged successfully!');
                
                // Update balance
                await updateBalance(-cost);
            } catch (error) {
                console.error('Error merging PDFs:', error);
                showMessage('error', 'Failed to merge PDFs. Please try again.');
            } finally {
                hideLoadingOverlay();
            }
        }

        function downloadMergedPdf() {
            if (mergedPdf) {
                const blob = new Blob([mergedPdf], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'merged_document.pdf';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        // --- Application Letter Logic ---
        async function generateLetter() {
            const fullName = document.getElementById('fullName').value;
            const phone = document.getElementById('phone').value;
            const email = document.getElementById('email').value;
            const address = document.getElementById('address').value;
            const appDate = document.getElementById('appDate').value;

            if (!fullName || !phone || !email || !address || !appDate || cvFilesArray.length === 0 || jdFilesArray.length === 0) {
                showMessage('error', 'Please fill all fields and upload at least one file for both CV and Job Description.');
                return;
            }

            const cost = 1.95;

            if (userBalance < cost) {
                showMessage('error', `Not enough balance. Please top up your account. Cost: ${cost} ETB`);
                return;
            }

            showLoadingOverlay('Preparing your files...');
            updateLetterProgress(1);

            try {
                // Process CV files to base64
                const cvFilesData = [];
                for (let i = 0; i < cvFilesArray.length; i++) {
                    const file = cvFilesArray[i];
                    const base64Data = await fileToBase64(file);
                    cvFilesData.push({
                        data: base64Data,
                        type: file.type
                    });
                }

                // Process JD files to base64
                const jdFilesData = [];
                for (let i = 0; i < jdFilesArray.length; i++) {
                    const file = jdFilesArray[i];
                    const base64Data = await fileToBase64(file);
                    jdFilesData.push({
                        data: base64Data,
                        type: file.type
                    });
                }

                console.log("Extracting text from CV files...");
                updateLetterProgress(1);
                
                // Step 1: Extract text from CV files
                const cvExtractionResponse = await fetch('/.netlify/functions/extract-text', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        files: cvFilesData,
                        fileType: 'cv'
                    })
                });

                if (!cvExtractionResponse.ok) {
                    const errorData = await cvExtractionResponse.json();
                    
                    // Check if it's an image-based PDF error
                    if (errorData.error && errorData.error.includes('image-based')) {
                        showImageBasedPdfPopup('cv');
                        hideLoadingOverlay();
                        return;
                    }
                    
                    throw new Error(`CV extraction failed: ${errorData.error}`);
                }

                const cvExtractionResult = await cvExtractionResponse.json();
                const cvText = cvExtractionResult.extractedText;

                console.log("Extracting text from JD files...");
                updateLetterProgress(1);
                
                // Step 2: Extract text from JD files
                const jdExtractionResponse = await fetch('/.netlify/functions/extract-text', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        files: jdFilesData,
                        fileType: 'jd'
                    })
                });

                if (!jdExtractionResponse.ok) {
                    const errorData = await jdExtractionResponse.json();
                    
                    // Check if it's an image-based PDF error
                    if (errorData.error && errorData.error.includes('image-based')) {
                        showImageBasedPdfPopup('jd');
                        hideLoadingOverlay();
                        return;
                    }
                    
                    throw new Error(`JD extraction failed: ${errorData.error}`);
                }

                const jdExtractionResult = await jdExtractionResponse.json();
                const jdText = jdExtractionResult.extractedText;

                console.log("Organizing your letter...");
                updateLetterProgress(2);
                
                console.log("Generating letter with AI...");
                updateLetterProgress(3);
                
                // Step 3: Generate letter with extracted text
                const letterResponse = await fetch('/.netlify/functions/generate-letter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fullName: fullName,
                        phone: phone,
                        email: email,
                        address: address,
                        appDate: appDate,
                        cvText: cvText,
                        jdText: jdText
                    })
                });

                if (!letterResponse.ok) {
                    const errorData = await letterResponse.json();
                    throw new Error(`Letter generation failed: ${errorData.error}`);
                }

                const result = await letterResponse.json();
                const letterText = result.letterText;

                if (letterText) {
                    document.getElementById('applicationLetter').value = letterText;
                    document.getElementById('downloadLetterBtn').classList.remove('hidden');
                    showMessage('success', 'Application letter generated successfully!');
                    
                    // Update balance
                    await updateBalance(-cost);
                } else {
                    showMessage('error', 'Could not generate letter. Please try again.');
                }

            } catch (error) {
                console.error('Error generating letter:', error);
                showMessage('error', error.message || 'An unexpected error occurred.');
            } finally {
                hideLoadingOverlay();
            }
        }

        async function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        function downloadLetterAsPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const letterContent = document.getElementById('applicationLetter').value;
            
            // Set font and size
            doc.setFont('Times-Roman');
            doc.setFontSize(12);
            
            // Calculate the maximum width for text (page width minus margins)
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15; // Reduced margins to use more horizontal space
            const maxWidth = pageWidth - (margin * 2);
            
            // Split the text into lines that fit within the maxWidth
            const lines = doc.splitTextToSize(letterContent, maxWidth);
            
            // Start position for text
            let y = 20;
            
            // Add each line to the PDF
            for (let i = 0; i < lines.length; i++) {
                // Add text line with full width
                doc.text(lines[i], margin, y);
                
                // Move to next line
                y += 7;
            }
            
            // Save the PDF
            doc.save('application_letter.pdf');
        };

        // --- Payment Logic ---
        window.showTopUpForm = () => {
            document.getElementById('topUpForm').classList.remove('hidden');
        };

        async function confirmPayment() {
            const screenshotFile = document.getElementById('paymentScreenshot').files[0];
            if (!screenshotFile) {
                showMessage('error', 'Please upload a screenshot.');
                return;
            }

            showLoadingOverlay('Confirming your payment...');

            try {
                const screenshotData = await fileToBase64(screenshotFile);

                const response = await fetch('/.netlify/functions/process-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userId,
                        screenshotData: screenshotData,
                        screenshotType: screenshotFile.type
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Payment Error:', errorData);
                    showMessage('error', `Payment Error: ${response.statusText}`);
                    return;
                }

                const result = await response.json();
                
                if (result.success) {
                    userBalance = result.newBalance;
                    document.getElementById('balanceDisplay').textContent = userBalance.toFixed(2);
                    showMessage('success', 'Payment confirmed! Your balance has been updated.');
                    document.getElementById('topUpForm').classList.add('hidden');
                } else {
                    showMessage('error', result.message || 'Payment failed');
                }

            } catch (error) {
                console.error('Error confirming payment:', error);
                showMessage('error', 'An unexpected error occurred during payment confirmation.');
            } finally {
                hideLoadingOverlay();
            }
        }

        // Function to update user balance
        async function updateBalance(amount) {
            try {
                const response = await fetch('/.netlify/functions/update-balance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        userId: userId,
                        amount: amount
                    }),
                });

                const data = await response.json();

                if (response.ok) {
                    userBalance = data.balance;
                    document.getElementById('balanceDisplay').textContent = userBalance.toFixed(2);
                    return true;
                } else {
                    console.error('Balance update error:', data.error);
                    return false;
                }
            } catch (error) {
                console.error('Balance update error:', error);
                return false;
            }
        }
    </script>
    <style>
        .animate-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Modern Loading Animation */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            80%, 100% { transform: scale(2); opacity: 0; }
        }
        
        .animate-float {
            animation: float 2s ease-in-out infinite;
        }
        
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
        
        .animate-pulse-ring {
            animation: pulse-ring 2s cubic-bezier(0.455, 0.030, 0.515, 0.955) infinite;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        
        /* Custom file input styling - FIXED */
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .file-input-wrapper input[type="file"] {
            color: transparent;
        }
        .file-count-display {
            position: absolute;
            right: 100px; /* Moved left to be closer to the button */
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            background: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            z-index: 10;
            border: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        /* Ensure the file list container doesn't affect the counter position */
        #cvFilesList, #jdFilesList, #pdfFilesList {
            position: relative;
            z-index: 1;
            margin-top: 0.5rem; /* Add some spacing above the file list */
        }
        /* Fix for file input container to prevent shifting */
        .file-input-container {
            position: relative;
            margin-bottom: 0.5rem;
        }
        .file-list-container {
            margin-top: 0.5rem;
        }
        
        /* Dark mode styles */
        .dark {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        
        .dark .bg-white {
            background-color: #2d3748;
        }
        
        .dark .bg-gray-100 {
            background-color: #1a202c;
        }
        
        .dark .bg-gray-50 {
            background-color: #2d3748;
        }
        
        .dark .text-gray-800 {
            color: #e2e8f0;
        }
        
        .dark .text-gray-700 {
            color: #e2e8f0;
        }
        
        .dark .text-gray-600 {
            color: #cbd5e0;
        }
        
        .dark .text-gray-500 {
            color: #a0aec0;
        }
        
        .dark .border-gray-200 {
            border-color: #4a5568;
        }
        
        .dark .border-gray-300 {
            border-color: #4a5568;
        }
        
        .dark .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }
        
        .dark .shadow-inner {
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.2);
        }
        
        .dark input, .dark textarea {
            background-color: #2d3748;
            color: #e2e8f0;
            border-color: #4a5568;
        }
        
        .dark input::placeholder, .dark textarea::placeholder {
            color: #a0aec0;
        }
        
        .dark input:focus, .dark textarea:focus {
            border-color: #667eea;
            background-color: #2d3748;
        }
        
        .dark .file-count-display {
            background-color: #2d3748;
            color: #e2e8f0;
            border-color: #4a5568;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-[Inter]">

    <!-- Message Box -->
    <div id="messageBox" class="hidden">
        <p id="messageText"></p>
    </div>

    <!-- Modern Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 dark:bg-gray-800">
            <div class="text-center">
                <!-- Animated Spinner -->
                <div class="relative mx-auto w-20 h-20 mb-6">
                    <div class="absolute inset-0 rounded-full border-4 border-indigo-200 animate-pulse-ring"></div>
                    <div class="absolute inset-2 rounded-full border-4 border-indigo-500 animate-spin-slow"></div>
                    <div class="absolute inset-4 rounded-full bg-gradient-to-r from-blue-400 to-green-400 animate-float"></div>
                </div>
                
                <!-- Loading Text -->
                <h3 id="loadingMessage" class="text-lg font-semibold text-gray-800 mb-2 dark:text-white">Processing...</h3>
                
                <!-- Progress Bar for Letter Generation -->
                <div id="progressContainer" class="w-full bg-gray-200 rounded-full h-2 mt-4 hidden">
                    <div id="progressBar" class="progress-bar h-2 rounded-full gradient-bg" style="width: 0%"></div>
                </div>
                
                <!-- Subtle Animation Dots -->
                <div class="flex justify-center space-x-1 mt-4">
                    <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                    <div class="w-2 h-2 bg-green-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.3s"></div>
                    <div class="w-2 h-2 bg-green-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                </div>
                
                <p class="text-sm text-gray-500 mt-3 dark:text-gray-400">Please wait while we process your request</p>
            </div>
        </div>
    </div>

    <!-- Image-based PDF Popup -->
    <div id="imageBasedPdfPopup" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-lg max-w-md w-full mx-4 dark:bg-gray-800">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 dark:bg-red-900">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2 dark:text-white">Image-based PDF Detected</h3>
                <p id="imageBasedPdfMessage" class="text-sm text-gray-600 mb-4 dark:text-gray-300">
                    <!-- Dynamic message will be inserted here -->
                </p>
                <p class="text-xs text-gray-500 mb-4 dark:text-gray-400">
                    Tip: Take screenshots of each page and upload them as images (JPG or PNG).
                </p>
                <button onclick="closeImageBasedPdfPopup()" class="w-full bg-indigo-500 text-white py-2 px-4 rounded-full font-semibold hover:bg-indigo-600 transition-colors">
                    OK, I Understand
                </button>
            </div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 bg-gray-100 flex items-center justify-center p-4 dark:bg-gray-900">
        <div class="bg-white p-8 rounded-xl shadow-lg max-w-md w-full dark:bg-gray-800">
            <h1 class="text-3xl font-bold text-center text-indigo-600 mb-2">CVerve</h1>
            <p class="text-sm text-center text-gray-500 mb-6 dark:text-gray-400">Login to access your account</p>
            
            <div id='loginForm'>
                <div class="mb-4">
                    <label for="userIdInput" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Your User ID</label>
                    <input type="text" id="userIdInput" placeholder="Enter your User ID" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                
                <button onclick="handleLogin()" class="w-full bg-indigo-500 text-white py-2 px-4 rounded-full font-semibold hover:bg-indigo-600 transition-colors duration-200 shadow-md mb-4">
                    Login
                </button>
                
                <div class="text-center">
                    <p class="text-sm text-gray-600 dark:text-gray-400">Don't have a User ID?</p>
                    <button onclick="generateNewUserId()" class="text-indigo-600 font-semibold text-sm hover:underline mt-1 dark:text-indigo-400">
                        Generate New User ID
                    </button>
                </div>
            </div>
            
            <div id="newUserIdSection" class="hidden">
                <div class="bg-yellow-50 p-4 rounded-lg text-sm text-yellow-800 mb-4 dark:bg-yellow-900 dark:text-yellow-200">
                    <h3 class="font-bold mb-2">Important!</h3>
                    <p>Please save this User ID in a secure place. You will need it to access your account in the future.</p>
                </div>
                
                <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg mb-4 dark:bg-gray-700">
                    <span id="generatedUserId" class="font-mono text-sm dark:text-white"></span>
                    <button id="copyUserIdBtn" onclick="copyGeneratedUserId()" class="bg-indigo-100 text-indigo-700 p-2 rounded-full hover:bg-indigo-200 transition-colors dark:bg-indigo-900 dark:text-indigo-300 dark:hover:bg-indigo-800">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                    </button>
                </div>
                
                <button onclick="showSaveConfirmation()" class="w-full bg-emerald-500 text-white py-2 px-4 rounded-full font-semibold hover:bg-emerald-600 transition-colors duration-200 shadow-md">
                    Continue
                </button>
            </div>
            
            <div id="saveConfirmation" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                <div class="bg-white p-6 rounded-xl shadow-lg max-w-sm w-full mx-4 dark:bg-gray-800">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 dark:text-white">Have you saved your User ID in a safe place?</h3>
                    <p class="text-sm text-gray-600 mb-6 dark:text-gray-400">You won't be able to recover your account if you lose this ID.</p>
                    <div class="flex space-x-4">
                        <button onclick="handleSaveConfirmation(false)" class="flex-1 bg-red-500 text-white py-2 px-4 rounded-full font-semibold">
                            No
                        </button>
                        <button onclick="handleSaveConfirmation(true)" class="flex-1 bg-emerald-500 text-white py-2 px-4 rounded-full font-semibold">
                            Yes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <div class="container mx-auto p-4 max-w-lg mt-8 rounded-xl shadow-lg bg-white dark:bg-gray-800">
            
            <!-- Header with User ID - UPDATED LAYOUT -->
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-3xl font-bold text-indigo-600">CVerve</h1>
                <div class="flex flex-col items-end">
                    <span class="text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">User ID</span>
                    <div class="flex items-center space-x-1">
                        <span id="dashboardUserId" class="text-sm text-gray-500 font-mono dark:text-gray-400"></span>
                        <button onclick="toggleUserIdVisibility()" class="text-indigo-600 hover:text-indigo-800 p-1 rounded-full dark:text-indigo-400 dark:hover:text-indigo-300">
                            <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>
                        <button onclick="copyToClipboard(userId)" class="text-indigo-600 hover:text-indigo-800 p-1 rounded-full dark:text-indigo-400 dark:hover:text-indigo-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                        </button>
                    </div>
                    <!-- Dark Mode Toggle Button -->
                    <button onclick="toggleDarkMode()" class="mt-2 text-indigo-600 hover:text-indigo-800 p-1 rounded-full dark:text-indigo-400 dark:hover:text-indigo-300">
                        <svg id="darkModeIcon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div class="flex border-b border-gray-200 mb-4 dark:border-gray-700">
                <button id="merger-button" onclick="switchTab('merger')" class="tab-button w-1/3 py-2 text-center text-sm font-semibold text-gray-600 border-b-2 border-indigo-500 dark:text-gray-400">PDF Merger</button>
                <button id="letter-button" onclick="switchTab('letter')" class="tab-button w-1/3 py-2 text-center text-sm font-semibold text-gray-600 dark:text-gray-400">Application Letter</button>
                <button id="payment-button" onclick="switchTab('payment')" class="tab-button w-1/3 py-2 text-center text-sm font-semibold text-gray-600 dark:text-gray-400">Payment</button>
            </div>

            <!-- Tab Content Containers -->
            <div id="merger-content" class="tab-content">
                <div class="p-4 bg-gray-50 rounded-lg shadow-inner dark:bg-gray-700">
                    <h2 class="text-xl font-semibold mb-4 text-center dark:text-white">PDF Merger</h2>
                    <div class="space-y-4">
                        <div class="file-input-container">
                            <label class="block">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Upload PDFs in order:</span>
                                <div class="file-input-wrapper mt-1">
                                    <input type="file" id="pdfInput" multiple accept="application/pdf" class="w-full text-sm text-transparent file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition duration-150 dark:file:bg-indigo-900 dark:file:text-indigo-300 dark:hover:file:bg-indigo-800">
                                    <span id="pdfFilesCounter" class="file-count-display">0 files selected</span>
                                </div>
                            </label>
                            <div id="pdfFilesList" class="file-list-container max-h-32 overflow-y-auto">
                                <!-- File list will be populated here -->
                            </div>
                        </div>
                        <button id="mergePdfBtn" class="w-full bg-indigo-500 text-white py-2 px-4 rounded-full font-semibold hover:bg-indigo-600 transition-colors duration-200 shadow-md">Merge PDFs</button>
                        <button id="downloadPdfBtn" class="w-full bg-emerald-500 text-white py-2 px-4 rounded-full font-semibold hidden hover:bg-emerald-600 transition-colors duration-200 shadow-md">Download Merged PDF</button>
                    </div>
                </div>
            </div>

            <div id="letter-content" class="tab-content hidden">
                <div class="p-4 bg-gray-50 rounded-lg shadow-inner dark:bg-gray-700">
                    <h2 class="text-xl font-semibold mb-4 text-center dark:text-white">Application Letter Writer</h2>
                    <div class="space-y-4">
                        <input type="text" id="fullName" placeholder="Full Name" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                        <input type="tel" id="phone" placeholder="Phone Number" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                        <input type="email" id="email" placeholder="Email" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                        <input type="text" id="address" placeholder="Address" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                        <input type="date" id="appDate" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                        
                        <div class="file-input-container">
                            <label class="block">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Upload Your CV Files (Image, PDF, Word)</span>
                                <div class="file-input-wrapper mt-1">
                                    <input type="file" id="cvFile" multiple accept="image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" class="w-full text-sm text-transparent file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition duration-150 dark:file:bg-indigo-900 dark:file:text-indigo-300 dark:hover:file:bg-indigo-800">
                                    <span id="cvFilesCounter" class="file-count-display">0 files selected</span>
                                </div>
                            </label>
                            <div id="cvFilesList" class="file-list-container max-h-32 overflow-y-auto">
                                <!-- File list will be populated here -->
                            </div>
                        </div>
                        
                        <div class="file-input-container">
                            <label class="block">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Upload Job Description Files (Image, PDF, Word)</span>
                                <div class="file-input-wrapper mt-1">
                                    <input type="file" id="jdFile" multiple accept="image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" class="w-full text-sm text-transparent file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition duration-150 dark:file:bg-indigo-900 dark:file:text-indigo-300 dark:hover:file:bg-indigo-800">
                                    <span id="jdFilesCounter" class="file-count-display">0 files selected</span>
                                </div>
                            </label>
                            <div id="jdFilesList" class="file-list-container max-h-32 overflow-y-auto">
                                <!-- File list will be populated here -->
                            </div>
                        </div>
                        
                        <button id="generateLetterBtn" class="w-full bg-indigo-500 text-white py-2 px-4 rounded-full font-semibold hover:bg-indigo-600 transition-colors duration-200 shadow-md">Generate Application Letter</button>
                        <div id="loadingIndicator" class="hidden text-center text-sm font-medium text-gray-500 dark:text-gray-400">Generating letter...</div>
                        <textarea id="applicationLetter" rows="10" placeholder="Your generated application letter will appear here..." class="w-full p-4 rounded-lg border border-gray-300 resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white"></textarea>
                        <button id="downloadLetterBtn" class="w-full bg-emerald-500 text-white py-2 px-4 rounded-full font-semibold hidden hover:bg-emerald-600 transition-colors duration-200 shadow-md">Download as PDF</button>
                    </div>
                </div>
            </div>

            <div id="payment-content" class="tab-content hidden">
                <div class="p-4 bg-gray-50 rounded-lg shadow-inner dark:bg-gray-700">
                    <h2 class="text-xl font-semibold mb-4 text-center dark:text-white">Payment & Balance</h2>
                    <div class="flex items-center justify-between mb-4 bg-white p-4 rounded-lg shadow dark:bg-gray-600">
                        <span class="text-lg font-bold text-gray-700 dark:text-white">Balance: <span id="balanceDisplay">0.00</span> ETB</span>
                        <button onclick="showTopUpForm()" class="bg-indigo-500 text-white py-2 px-4 rounded-full font-semibold text-sm hover:bg-indigo-600 transition-colors duration-200 shadow-md">Top Up</button>
                    </div>
                    
                    <div id="topUpForm" class="hidden space-y-4">
                        <div class="bg-yellow-50 p-4 rounded-lg text-sm text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">
                            <h3 class="font-bold mb-2">Payment Instructions:</h3>
                            <p>✔️ Payment Method: Bank Transfer</p>
                            <p>✔️ Bank: Commercial Bank of Ethiopia</p>
                            <p>✔️ Account Number: 1000577617639</p>
                            <p>✔️ Account Name: YILAK ABAY ABEBE</p>
                            <p>✔️ Amount: Minimum 30 ETB</p>
                            <p class="mt-2">After you pay please send the screenshot of the text you received from CBE below.</p>
                        </div>
                        <label class="block">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Upload your payment screenshot</span>
                            <input type="file" id="paymentScreenshot" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition duration-150 dark:file:bg-indigo-900 dark:file:text-indigo-300 dark:hover:file:bg-indigo-800">
                        </label>
                        <button id="confirmPaymentBtn" class="w-full bg-indigo-500 text-white py-2 px-4 rounded-full font-semibold hover:bg-indigo-600 transition-colors duration-200 shadow-md">Confirm Payment</button>
                        <div id="loadingIndicatorPayment" class="hidden text-center text-sm font-medium text-gray-500 dark:text-gray-400">Confirming payment...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize progress bar for letter generation
        document.addEventListener('DOMContentLoaded', function() {
            const progressContainer = document.getElementById('progressContainer');
            const generateLetterBtn = document.getElementById('generateLetterBtn');
            
            if (generateLetterBtn) {
                generateLetterBtn.addEventListener('click', function() {
                    progressContainer.classList.remove('hidden');
                });
            }
        });
    </script>
</body>
</html>